"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.KalturaUploadRequestAdapter = void 0;
var tslib_1 = require("tslib");
var utils_1 = require("./utils");
var kaltura_client_exception_1 = require("../api/kaltura-client-exception");
var kaltura_api_exception_1 = require("../api/kaltura-api-exception");
var cancelable_action_1 = require("../cancelable-action");
var got_1 = require("got");
var FormData = require("form-data");
var kaltura_logger_1 = require("../api/kaltura-logger");
var serviceStr = 'uploadtoken';
var actionStr = 'upload';
var KalturaUploadRequestAdapter = /** @class */ (function () {
    function KalturaUploadRequestAdapter(clientOptions, defaultRequestOptions) {
        this.clientOptions = clientOptions;
        this.defaultRequestOptions = defaultRequestOptions;
        /* noop */
    }
    KalturaUploadRequestAdapter.prototype.transmit = function (request) {
        var _this = this;
        return new cancelable_action_1.CancelableAction(function (resolve, reject, action) {
            var uploadedFileSize = !isNaN(request.uploadedFileSize) && isFinite(request.uploadedFileSize) && request.uploadedFileSize > 0
                ? request.uploadedFileSize
                : 0;
            var data = {
                resume: !!uploadedFileSize,
                finalChunk: false,
                resumeAt: uploadedFileSize
            };
            var activeAction;
            var handleChunkUploadError = function (reason) {
                activeAction = null;
                reject(reason);
            };
            var handleChunkUploadSuccess = function (result) {
                if (!data.finalChunk) {
                    activeAction = _this._chunkUpload(request, data).then(handleChunkUploadSuccess, handleChunkUploadError);
                    return;
                }
                activeAction = null;
                try {
                    var response = request.handleResponse(result);
                    if (response.error) {
                        throw response.error;
                    }
                    else {
                        resolve(response.result);
                    }
                }
                catch (error) {
                    if (error instanceof kaltura_client_exception_1.KalturaClientException) {
                        reject(new kaltura_client_exception_1.KalturaClientException(error.message, error.code, tslib_1.__assign(tslib_1.__assign({}, (error.args || {})), { service: serviceStr, action: actionStr })));
                    }
                    else if (error instanceof kaltura_api_exception_1.KalturaAPIException) {
                        reject(new kaltura_api_exception_1.KalturaAPIException(error.message, error.code, tslib_1.__assign(tslib_1.__assign({}, (error.args || {})), { service: serviceStr, action: actionStr })));
                    }
                    else {
                        var errorMessage = error instanceof Error ? error.message : typeof error === 'string' ? error : null;
                        reject(new kaltura_client_exception_1.KalturaClientException('client::response-unknown-error', errorMessage || 'Failed to parse response', { service: serviceStr, action: actionStr }));
                    }
                }
            };
            activeAction = _this._chunkUpload(request, data).then(handleChunkUploadSuccess, handleChunkUploadError);
            return function () {
                if (activeAction) {
                    activeAction.cancel();
                    activeAction = null;
                }
            };
        });
    };
    KalturaUploadRequestAdapter.prototype._getFormData = function (_a) {
        var fileName = _a.fileName, fileData = _a.fileData, ks = _a.ks;
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var form, ab, buffer;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        form = new FormData();
                        form.append('fileName', fileName);
                        form.append('ks', ks);
                        return [4 /*yield*/, fileData.arrayBuffer()];
                    case 1:
                        ab = _b.sent();
                        buffer = Buffer.from(ab);
                        form.append('fileData', buffer, { contentType: fileData.type, filename: fileName });
                        return [2 /*return*/, form];
                }
            });
        });
    };
    KalturaUploadRequestAdapter.prototype._getChunkFileSize = function () {
        var userChunkFileSize = this.clientOptions ? this.clientOptions.chunkFileSize : null;
        var actualChunkFileSize = 5e6; // default 5 mb
        if (userChunkFileSize && Number.isFinite(userChunkFileSize) && !Number.isNaN(userChunkFileSize)) {
            if (userChunkFileSize < 1e5) {
                kaltura_logger_1.Logger.warn("user requested for invalid upload chunk size '".concat(userChunkFileSize, "'. minimal value 100Kb. using minimal value 100Kb instead"));
                actualChunkFileSize = 1e5;
            }
            else {
                actualChunkFileSize = userChunkFileSize;
            }
        }
        kaltura_logger_1.Logger.info("using chunk size of ".concat(userChunkFileSize, " bytes"));
        return actualChunkFileSize;
    };
    KalturaUploadRequestAdapter.prototype._prepareRequest = function (request, uploadChunkData) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var actualChunkFileSize, file, fileStart, fileEnd, form, _a, service, action, ks, params, endpointUrl, searchParams;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        actualChunkFileSize = this._getChunkFileSize();
                        file = request.getFileInfo().file;
                        uploadChunkData.finalChunk = (file.size - uploadChunkData.resumeAt) <= actualChunkFileSize;
                        fileStart = uploadChunkData.resumeAt;
                        fileEnd = uploadChunkData.finalChunk ? file.size : fileStart + actualChunkFileSize;
                        return [4 /*yield*/, this._getFormData({
                                fileName: file.name,
                                fileData: file.slice(fileStart, fileEnd, file.type),
                                ks: this.defaultRequestOptions.ks
                            })];
                    case 1:
                        form = _b.sent();
                        _a = (0, utils_1.prepareParameters)(request, this.clientOptions, this.defaultRequestOptions), service = _a.service, action = _a.action, ks = _a.ks, params = tslib_1.__rest(_a, ["service", "action", "ks"]);
                        endpointUrl = (0, utils_1.createEndpoint)(request, this.clientOptions, service, action);
                        searchParams = new URLSearchParams(tslib_1.__assign(tslib_1.__assign({}, params), { resume: uploadChunkData.resume, resumeAt: uploadChunkData.resumeAt, finalChunk: uploadChunkData.finalChunk }));
                        return [2 /*return*/, { endpointUrl: endpointUrl, form: form, searchParams: searchParams }];
                }
            });
        });
    };
    KalturaUploadRequestAdapter.prototype._chunkUpload = function (request, uploadChunkData) {
        var _this = this;
        return new cancelable_action_1.CancelableAction(function (resolve, reject) {
            var isComplete = false, isAborted = false;
            var xMe, xKalturaSession;
            var gotRequest;
            _this._prepareRequest(request, uploadChunkData).then(function (_a) {
                var endpointUrl = _a.endpointUrl, form = _a.form, searchParams = _a.searchParams;
                if (isAborted) {
                    return;
                }
                gotRequest = got_1.default.post(endpointUrl, { body: form, searchParams: searchParams });
                // save headers and parse response:
                gotRequest.then(function (response) {
                    var _a, _b;
                    isComplete = true;
                    xMe = ((_a = response === null || response === void 0 ? void 0 : response.headers) === null || _a === void 0 ? void 0 : _a['x-me']) || '';
                    xKalturaSession = ((_b = response === null || response === void 0 ? void 0 : response.headers) === null || _b === void 0 ? void 0 : _b['x-kaltura-session']) || '';
                    kaltura_logger_1.Logger.debug("Kaltura response completed for: ".concat(serviceStr, "/").concat(actionStr, ", x-me: ").concat(xMe, ", x-kaltura-session: ").concat(xKalturaSession));
                    return gotRequest.json();
                })
                    // handle parsed response:
                    .then(function (parsedResponse) {
                    if ((parsedResponse === null || parsedResponse === void 0 ? void 0 : parsedResponse.objectType) === 'KalturaAPIException') {
                        reject(new kaltura_api_exception_1.KalturaAPIException(parsedResponse.message, parsedResponse.code, tslib_1.__assign(tslib_1.__assign({}, (parsedResponse.args || {})), { service: serviceStr, action: actionStr })));
                        return;
                    }
                    if (parsedResponse.uploadedFileSize === undefined || parsedResponse.uploadedFileSize === null) {
                        reject(new kaltura_client_exception_1.KalturaClientException('client::upload-failure', "uploaded chunk of file failed, expected response with property 'uploadedFileSize'", { service: serviceStr, action: actionStr }));
                        return;
                    }
                    if (!uploadChunkData.finalChunk) {
                        uploadChunkData.resumeAt = Number(parsedResponse.uploadedFileSize);
                        uploadChunkData.resume = true;
                    }
                    resolve(parsedResponse);
                })
                    // handle errors:
                    .catch(function (e) {
                    var _a, _b, _c, _d, _e;
                    isComplete = true;
                    xMe || (xMe = ((_b = (_a = e.response) === null || _a === void 0 ? void 0 : _a.headers) === null || _b === void 0 ? void 0 : _b['x-me']) || '');
                    xKalturaSession || (xKalturaSession = ((_d = (_c = e.response) === null || _c === void 0 ? void 0 : _c.headers) === null || _d === void 0 ? void 0 : _d['x-kaltura-session']) || '');
                    var msg = ((_e = e.response) === null || _e === void 0 ? void 0 : _e.body) || e.message || 'failed to upload file';
                    var err = new kaltura_client_exception_1.KalturaClientException('client::upload-failure', msg);
                    kaltura_logger_1.Logger.error("Kaltura response error: '".concat(msg || '', "', for: ").concat(serviceStr, "/").concat(actionStr, ", x-me: ").concat(xMe, ", x-kaltura-session: ").concat(xKalturaSession));
                    reject(err);
                });
            });
            return function () {
                if (!isComplete) {
                    isComplete = true;
                    isAborted = true;
                    gotRequest === null || gotRequest === void 0 ? void 0 : gotRequest.cancel();
                }
            };
        });
    };
    return KalturaUploadRequestAdapter;
}());
exports.KalturaUploadRequestAdapter = KalturaUploadRequestAdapter;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFkYXB0ZXJzL2thbHR1cmEtdXBsb2FkLXJlcXVlc3QtYWRhcHRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQ0EsaUNBQTREO0FBQzVELDRFQUF5RTtBQUd6RSxzRUFBbUU7QUFDbkUsMERBQXdEO0FBQ3hELDJCQUFzQjtBQUN0QixvQ0FBc0M7QUFDdEMsd0RBQStDO0FBUS9DLElBQU0sVUFBVSxHQUFHLGFBQXNCLENBQUE7QUFDekMsSUFBTSxTQUFTLEdBQUcsUUFBaUIsQ0FBQTtBQUVuQztJQUNFLHFDQUFtQixhQUFtQyxFQUFTLHFCQUE0QztRQUF4RixrQkFBYSxHQUFiLGFBQWEsQ0FBc0I7UUFBUywwQkFBcUIsR0FBckIscUJBQXFCLENBQXVCO1FBQ3pHLFVBQVU7SUFDWixDQUFDO0lBRUQsOENBQVEsR0FBUixVQUFTLE9BQWtDO1FBQTNDLGlCQW1EQztRQWxEQyxPQUFPLElBQUksb0NBQWdCLENBQUMsVUFBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU07WUFDbEQsSUFBTSxnQkFBZ0IsR0FBRyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxRQUFRLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLElBQUksT0FBTyxDQUFDLGdCQUFnQixHQUFHLENBQUM7Z0JBQzdILENBQUMsQ0FBQyxPQUFPLENBQUMsZ0JBQWdCO2dCQUMxQixDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ04sSUFBTSxJQUFJLEdBQXVCO2dCQUMvQixNQUFNLEVBQUUsQ0FBQyxDQUFDLGdCQUFnQjtnQkFDMUIsVUFBVSxFQUFFLEtBQUs7Z0JBQ2pCLFFBQVEsRUFBRSxnQkFBZ0I7YUFDM0IsQ0FBQztZQUNGLElBQUksWUFBbUMsQ0FBQztZQUV4QyxJQUFNLHNCQUFzQixHQUFHLFVBQUMsTUFBTTtnQkFDcEMsWUFBWSxHQUFHLElBQUksQ0FBQztnQkFDcEIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ2pCLENBQUMsQ0FBQTtZQUVE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R0FBRyxHQUFHLElBQUksaURBQXNCLENBQUMsd0JBQXdCLEVBQUUsR0FBRyxDQUFDLENBQUM7b0JBQ3RFLHVCQUFNLENBQUMsS0FBSyxDQUFDLG1DQUE0QixHQUFHLElBQUksRUFBRSxxQkFBVyxVQUFVLGNBQUksU0FBUyxxQkFBVyxHQUFHLGtDQUF3QixlQUFlLENBQUUsQ0FBQyxDQUFBO29CQUM1SSxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUE7Z0JBQ2IsQ0FBQyxDQUFDLENBQUE7WUFDSixDQUFDLENBQUMsQ0FBQTtZQUVGLE9BQU87Z0JBQ0wsSUFBSSxDQUFDLFVBQVUsRUFBRTtvQkFDZixVQUFVLEdBQUcsSUFBSSxDQUFDO29CQUNsQixTQUFTLEdBQUcsSUFBSSxDQUFBO29CQUNoQixVQUFVLGFBQVYsVUFBVSx1QkFBVixVQUFVLENBQUUsTUFBTSxFQUFFLENBQUM7aUJBQ3RCO1lBQ0gsQ0FBQyxDQUFBO1FBQ0gsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDO0lBQ0gsa0NBQUM7QUFBRCxDQTFLQSxBQTBLQyxJQUFBO0FBMUtZLGtFQUEyQiIsImZpbGUiOiJhZGFwdGVycy9rYWx0dXJhLXVwbG9hZC1yZXF1ZXN0LWFkYXB0ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBLYWx0dXJhVXBsb2FkUmVxdWVzdCB9IGZyb20gJy4uL2FwaS9rYWx0dXJhLXVwbG9hZC1yZXF1ZXN0JztcbmltcG9ydCB7IGNyZWF0ZUVuZHBvaW50LCBwcmVwYXJlUGFyYW1ldGVycyB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHsgS2FsdHVyYUNsaWVudEV4Y2VwdGlvbiB9IGZyb20gJy4uL2FwaS9rYWx0dXJhLWNsaWVudC1leGNlcHRpb24nO1xuaW1wb3J0IHsgS2FsdHVyYVJlcXVlc3RPcHRpb25zIH0gZnJvbSAnLi4vYXBpL2thbHR1cmEtcmVxdWVzdC1vcHRpb25zJztcbmltcG9ydCB7IEthbHR1cmFDbGllbnRPcHRpb25zIH0gZnJvbSAnLi4va2FsdHVyYS1jbGllbnQtb3B0aW9ucyc7XG5pbXBvcnQgeyBLYWx0dXJhQVBJRXhjZXB0aW9uIH0gZnJvbSAnLi4vYXBpL2thbHR1cmEtYXBpLWV4Y2VwdGlvbic7XG5pbXBvcnQgeyBDYW5jZWxhYmxlQWN0aW9uIH0gZnJvbSAnLi4vY2FuY2VsYWJsZS1hY3Rpb24nO1xuaW1wb3J0IGdvdCBmcm9tICdnb3QnO1xuaW1wb3J0ICogYXMgRm9ybURhdGEgZnJvbSAnZm9ybS1kYXRhJztcbmltcG9ydCB7IExvZ2dlciB9IGZyb20gXCIuLi9hcGkva2FsdHVyYS1sb2dnZXJcIjtcblxuaW50ZXJmYWNlIFVwbG9hZEJ5Q2h1bmtzRGF0YSB7XG4gIHJlc3VtZTogYm9vbGVhbjtcbiAgcmVzdW1lQXQ6IG51bWJlcjtcbiAgZmluYWxDaHVuazogYm9vbGVhbjtcbn1cblxuY29uc3Qgc2VydmljZVN0ciA9ICd1cGxvYWR0b2tlbicgYXMgY29uc3RcbmNvbnN0IGFjdGlvblN0ciA9ICd1cGxvYWQnIGFzIGNvbnN0XG5cbmV4cG9ydCBjbGFzcyBLYWx0dXJhVXBsb2FkUmVxdWVzdEFkYXB0ZXIge1xuICBjb25zdHJ1Y3RvcihwdWJsaWMgY2xpZW50T3B0aW9uczogS2FsdHVyYUNsaWVudE9wdGlvbnMsIHB1YmxpYyBkZWZhdWx0UmVxdWVzdE9wdGlvbnM6IEthbHR1cmFSZXF1ZXN0T3B0aW9ucykge1xuICAgIC8qIG5vb3AgKi9cbiAgfVxuXG4gIHRyYW5zbWl0KHJlcXVlc3Q6IEthbHR1cmFVcGxvYWRSZXF1ZXN0PGFueT4pOiBDYW5jZWxhYmxlQWN0aW9uPGFueT4ge1xuICAgIHJldHVybiBuZXcgQ2FuY2VsYWJsZUFjdGlvbigocmVzb2x2ZSwgcmVqZWN0LCBhY3Rpb24pID0+IHtcbiAgICAgIGNvbnN0IHVwbG9hZGVkRmlsZVNpemUgPSAhaXNOYU4ocmVxdWVzdC51cGxvYWRlZEZpbGVTaXplKSAmJiBpc0Zpbml0ZShyZXF1ZXN0LnVwbG9hZGVkRmlsZVNpemUpICYmIHJlcXVlc3QudXBsb2FkZWRGaWxlU2l6ZSA+IDBcbiAgICAgICAgPyByZXF1ZXN0LnVwbG9hZGVkRmlsZVNpemVcbiAgICAgICAgOiAwO1xuICAgICAgY29uc3QgZGF0YTogVXBsb2FkQnlDaHVua3NEYXRhID0ge1xuICAgICAgICByZXN1bWU6ICEhdXBsb2FkZWRGaWxlU2l6ZSxcbiAgICAgICAgZmluYWxDaHVuazogZmFsc2UsXG4gICAgICAgIHJlc3VtZUF0OiB1cGxvYWRlZEZpbGVTaXplXG4gICAgICB9O1xuICAgICAgbGV0IGFjdGl2ZUFjdGlvbjogQ2FuY2VsYWJsZUFjdGlvbjxhbnk+O1xuXG4gICAgICBjb25zdCBoYW5kbGVDaHVua1VwbG9hZEVycm9yID0gKHJlYXNvbikgPT4ge1xuICAgICAgICBhY3RpdmVBY3Rpb24gPSBudWxsO1xuICAgICAgICByZWplY3QocmVhc29uKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgaGFuZGxlQ2h1bmtVcGxvYWRTdWNjZXNzID0gKHJlc3VsdCkgPT4ge1xuICAgICAgICBpZiAoIWRhdGEuZmluYWxDaHVuaykge1xuICAgICAgICAgIGFjdGl2ZUFjdGlvbiA9IHRoaXMuX2NodW5rVXBsb2FkKHJlcXVlc3QsIGRhdGEpLnRoZW4oaGFuZGxlQ2h1bmtVcGxvYWRTdWNjZXNzLCBoYW5kbGVDaHVua1VwbG9hZEVycm9yKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBhY3RpdmVBY3Rpb24gPSBudWxsO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gcmVxdWVzdC5oYW5kbGVSZXNwb25zZShyZXN1bHQpO1xuICAgICAgICAgIGlmIChyZXNwb25zZS5lcnJvcikge1xuICAgICAgICAgICAgdGhyb3cgcmVzcG9uc2UuZXJyb3I7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc29sdmUocmVzcG9uc2UucmVzdWx0KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgS2FsdHVyYUNsaWVudEV4Y2VwdGlvbikge1xuICAgICAgICAgICAgcmVqZWN0KG5ldyBLYWx0dXJhQ2xpZW50RXhjZXB0aW9uKGVycm9yLm1lc3NhZ2UsIGVycm9yLmNvZGUsIHsgLi4uKGVycm9yLmFyZ3MgfHwge30pLCBzZXJ2aWNlOiBzZXJ2aWNlU3RyLCBhY3Rpb246IGFjdGlvblN0ciB9KSk7XG4gICAgICAgICAgfSBlbHNlIGlmIChlcnJvciBpbnN0YW5jZW9mIEthbHR1cmFBUElFeGNlcHRpb24pIHtcbiAgICAgICAgICAgIHJlamVjdChuZXcgS2FsdHVyYUFQSUV4Y2VwdGlvbihlcnJvci5tZXNzYWdlLCBlcnJvci5jb2RlLCB7IC4uLihlcnJvci5hcmdzIHx8IHt9KSwgc2VydmljZTogc2VydmljZVN0ciwgYWN0aW9uOiBhY3Rpb25TdHIgfSkpXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogdHlwZW9mIGVycm9yID09PSAnc3RyaW5nJyA/IGVycm9yIDogbnVsbDtcbiAgICAgICAgICAgIHJlamVjdChuZXcgS2FsdHVyYUNsaWVudEV4Y2VwdGlvbignY2xpZW50OjpyZXNwb25zZS11bmtub3duLWVycm9yJywgZXJyb3JNZXNzYWdlIHx8ICdGYWlsZWQgdG8gcGFyc2UgcmVzcG9uc2UnLCB7IHNlcnZpY2U6IHNlcnZpY2VTdHIsIGFjdGlvbjogYWN0aW9uU3RyIH0pKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgYWN0aXZlQWN0aW9uID0gdGhpcy5fY2h1bmtVcGxvYWQocmVxdWVzdCwgZGF0YSkudGhlbihoYW5kbGVDaHVua1VwbG9hZFN1Y2Nlc3MsIGhhbmRsZUNodW5rVXBsb2FkRXJyb3IpO1xuICAgICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgaWYgKGFjdGl2ZUFjdGlvbikge1xuICAgICAgICAgIGFjdGl2ZUFjdGlvbi5jYW5jZWwoKTtcbiAgICAgICAgICBhY3RpdmVBY3Rpb24gPSBudWxsO1xuICAgICAgICB9XG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBfZ2V0Rm9ybURhdGEoXG4gICAgeyBmaWxlTmFtZSwgZmlsZURhdGEsIGtzIH06IHsgZmlsZU5hbWU6IHN0cmluZywgZmlsZURhdGE6IEJsb2IsIGtzOnN0cmluZyB9XG4gICk6IFByb21pc2U8Rm9ybURhdGE+IHtcbiAgICBjb25zdCBmb3JtID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgZm9ybS5hcHBlbmQoJ2ZpbGVOYW1lJywgZmlsZU5hbWUpXG4gICAgZm9ybS5hcHBlbmQoJ2tzJywga3MpXG4gICAgY29uc3QgYWIgPSBhd2FpdCBmaWxlRGF0YS5hcnJheUJ1ZmZlcigpO1xuICAgIGNvbnN0IGJ1ZmZlciA9IEJ1ZmZlci5mcm9tKGFiKTtcbiAgICBmb3JtLmFwcGVuZCgnZmlsZURhdGEnLCBidWZmZXIsIHsgY29udGVudFR5cGU6IGZpbGVEYXRhLnR5cGUsIGZpbGVuYW1lOiBmaWxlTmFtZSB9KVxuICAgIHJldHVybiBmb3JtO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0Q2h1bmtGaWxlU2l6ZSgpOiBudW1iZXIge1xuICAgIGNvbnN0IHVzZXJDaHVua0ZpbGVTaXplID0gdGhpcy5jbGllbnRPcHRpb25zID8gdGhpcy5jbGllbnRPcHRpb25zLmNodW5rRmlsZVNpemUgOiBudWxsO1xuICAgIGxldCBhY3R1YWxDaHVua0ZpbGVTaXplID0gNWU2OyAvLyBkZWZhdWx0IDUgbWJcbiAgICBpZiAodXNlckNodW5rRmlsZVNpemUgJiYgTnVtYmVyLmlzRmluaXRlKHVzZXJDaHVua0ZpbGVTaXplKSAmJiAhTnVtYmVyLmlzTmFOKHVzZXJDaHVua0ZpbGVTaXplKSkge1xuICAgICAgaWYgKHVzZXJDaHVua0ZpbGVTaXplIDwgMWU1KSB7XG4gICAgICAgIExvZ2dlci53YXJuKGB1c2VyIHJlcXVlc3RlZCBmb3IgaW52YWxpZCB1cGxvYWQgY2h1bmsgc2l6ZSAnJHt1c2VyQ2h1bmtGaWxlU2l6ZX0nLiBtaW5pbWFsIHZhbHVlIDEwMEtiLiB1c2luZyBtaW5pbWFsIHZhbHVlIDEwMEtiIGluc3RlYWRgKVxuICAgICAgICBhY3R1YWxDaHVua0ZpbGVTaXplID0gMWU1O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYWN0dWFsQ2h1bmtGaWxlU2l6ZSA9IHVzZXJDaHVua0ZpbGVTaXplO1xuICAgICAgfVxuICAgIH1cbiAgICBMb2dnZXIuaW5mbyhgdXNpbmcgY2h1bmsgc2l6ZSBvZiAke3VzZXJDaHVua0ZpbGVTaXplfSBieXRlc2ApXG4gICAgcmV0dXJuIGFjdHVhbENodW5rRmlsZVNpemVcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgX3ByZXBhcmVSZXF1ZXN0KFxuICAgIHJlcXVlc3Q6IEthbHR1cmFVcGxvYWRSZXF1ZXN0PGFueT4sXG4gICAgdXBsb2FkQ2h1bmtEYXRhOiBVcGxvYWRCeUNodW5rc0RhdGFcbiAgKTogUHJvbWlzZTx7IGVuZHBvaW50VXJsOiBzdHJpbmcsIGZvcm06IEZvcm1EYXRhLCBzZWFyY2hQYXJhbXM6IFVSTFNlYXJjaFBhcmFtcyB9PiB7XG4gICAgY29uc3QgYWN0dWFsQ2h1bmtGaWxlU2l6ZSA9IHRoaXMuX2dldENodW5rRmlsZVNpemUoKTtcbiAgICBjb25zdCB7IGZpbGUgfSA9IHJlcXVlc3QuZ2V0RmlsZUluZm8oKTtcbiAgICB1cGxvYWRDaHVua0RhdGEuZmluYWxDaHVuayA9IChmaWxlLnNpemUgLSB1cGxvYWRDaHVua0RhdGEucmVzdW1lQXQpIDw9IGFjdHVhbENodW5rRmlsZVNpemU7XG4gICAgY29uc3QgZmlsZVN0YXJ0ID0gdXBsb2FkQ2h1bmtEYXRhLnJlc3VtZUF0O1xuICAgIGNvbnN0IGZpbGVFbmQgPSB1cGxvYWRDaHVua0RhdGEuZmluYWxDaHVuayA/IGZpbGUuc2l6ZSA6IGZpbGVTdGFydCArIGFjdHVhbENodW5rRmlsZVNpemU7XG5cbiAgICBjb25zdCBmb3JtID0gYXdhaXQgdGhpcy5fZ2V0Rm9ybURhdGEoe1xuICAgICAgZmlsZU5hbWU6IGZpbGUubmFtZSxcbiAgICAgIGZpbGVEYXRhOiBmaWxlLnNsaWNlKGZpbGVTdGFydCwgZmlsZUVuZCwgZmlsZS50eXBlKSxcbiAgICAgIGtzOiB0aGlzLmRlZmF1bHRSZXF1ZXN0T3B0aW9ucy5rc1xuICAgIH0pXG4gICAgY29uc3QgeyBzZXJ2aWNlLCBhY3Rpb24sIGtzLCAuLi5wYXJhbXMgfSA9IHByZXBhcmVQYXJhbWV0ZXJzKHJlcXVlc3QsIHRoaXMuY2xpZW50T3B0aW9ucywgdGhpcy5kZWZhdWx0UmVxdWVzdE9wdGlvbnMpO1xuICAgIGNvbnN0IGVuZHBvaW50VXJsID0gY3JlYXRlRW5kcG9pbnQocmVxdWVzdCwgdGhpcy5jbGllbnRPcHRpb25zLCBzZXJ2aWNlLCBhY3Rpb24pO1xuICAgIGNvbnN0IHNlYXJjaFBhcmFtcyA9IG5ldyBVUkxTZWFyY2hQYXJhbXMoe1xuICAgICAgLi4ucGFyYW1zLFxuICAgICAgcmVzdW1lOiB1cGxvYWRDaHVua0RhdGEucmVzdW1lLFxuICAgICAgcmVzdW1lQXQ6IHVwbG9hZENodW5rRGF0YS5yZXN1bWVBdCxcbiAgICAgIGZpbmFsQ2h1bms6IHVwbG9hZENodW5rRGF0YS5maW5hbENodW5rXG4gICAgfSlcbiAgICByZXR1cm4geyBlbmRwb2ludFVybCwgZm9ybSwgc2VhcmNoUGFyYW1zIH1cbiAgfVxuXG4gIHByaXZhdGUgX2NodW5rVXBsb2FkKFxuICAgIHJlcXVlc3Q6IEthbHR1cmFVcGxvYWRSZXF1ZXN0PGFueT4sXG4gICAgdXBsb2FkQ2h1bmtEYXRhOiBVcGxvYWRCeUNodW5rc0RhdGFcbiAgKTogQ2FuY2VsYWJsZUFjdGlvbjxhbnk+IHtcbiAgICByZXR1cm4gbmV3IENhbmNlbGFibGVBY3Rpb24oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgbGV0IGlzQ29tcGxldGUgPSBmYWxzZSwgaXNBYm9ydGVkID0gZmFsc2VcbiAgICAgIGxldCB4TWUsIHhLYWx0dXJhU2Vzc2lvblxuICAgICAgbGV0IGdvdFJlcXVlc3RcblxuICAgICAgdGhpcy5fcHJlcGFyZVJlcXVlc3QocmVxdWVzdCwgdXBsb2FkQ2h1bmtEYXRhKS50aGVuKChcbiAgICAgICAgeyBlbmRwb2ludFVybCwgZm9ybSwgc2VhcmNoUGFyYW1zIH06eyBlbmRwb2ludFVybDogc3RyaW5nLCBmb3JtOiBGb3JtRGF0YSwgc2VhcmNoUGFyYW1zOiBVUkxTZWFyY2hQYXJhbXMgfVxuICAgICAgKSA9PiB7XG4gICAgICAgIGlmIChpc0Fib3J0ZWQpIHsgcmV0dXJuIH1cbiAgICAgICAgZ290UmVxdWVzdCA9IGdvdC5wb3N0KGVuZHBvaW50VXJsLCB7IGJvZHk6IGZvcm0sIHNlYXJjaFBhcmFtczogPGFueT5zZWFyY2hQYXJhbXMgfSk7XG4gICAgICAgIC8vIHNhdmUgaGVhZGVycyBhbmQgcGFyc2UgcmVzcG9uc2U6XG4gICAgICAgIGdvdFJlcXVlc3QudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICAgICAgaXNDb21wbGV0ZSA9IHRydWVcbiAgICAgICAgICB4TWUgPSByZXNwb25zZT8uaGVhZGVycz8uWyd4LW1lJ10gfHwgJydcbiAgICAgICAgICB4S2FsdHVyYVNlc3Npb24gPSByZXNwb25zZT8uaGVhZGVycz8uWyd4LWthbHR1cmEtc2Vzc2lvbiddIHx8ICcnXG4gICAgICAgICAgTG9nZ2VyLmRlYnVnKGBLYWx0dXJhIHJlc3BvbnNlIGNvbXBsZXRlZCBmb3I6ICR7c2VydmljZVN0cn0vJHthY3Rpb25TdHJ9LCB4LW1lOiAke3hNZX0sIHgta2FsdHVyYS1zZXNzaW9uOiAke3hLYWx0dXJhU2Vzc2lvbn1gKVxuICAgICAgICAgIHJldHVybiBnb3RSZXF1ZXN0Lmpzb24oKVxuICAgICAgICB9KVxuICAgICAgICAvLyBoYW5kbGUgcGFyc2VkIHJlc3BvbnNlOlxuICAgICAgICAudGhlbigocGFyc2VkUmVzcG9uc2U6IGFueSkgPT4ge1xuICAgICAgICAgIGlmIChwYXJzZWRSZXNwb25zZT8ub2JqZWN0VHlwZSA9PT0gJ0thbHR1cmFBUElFeGNlcHRpb24nKSB7XG4gICAgICAgICAgICByZWplY3QobmV3IEthbHR1cmFBUElFeGNlcHRpb24ocGFyc2VkUmVzcG9uc2UubWVzc2FnZSwgcGFyc2VkUmVzcG9uc2UuY29kZSwgeyAuLi4ocGFyc2VkUmVzcG9uc2UuYXJncyB8fCB7fSksIHNlcnZpY2U6IHNlcnZpY2VTdHIsIGFjdGlvbjogYWN0aW9uU3RyIH0pKVxuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChwYXJzZWRSZXNwb25zZS51cGxvYWRlZEZpbGVTaXplID09PSB1bmRlZmluZWQgfHwgcGFyc2VkUmVzcG9uc2UudXBsb2FkZWRGaWxlU2l6ZSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgcmVqZWN0KG5ldyBLYWx0dXJhQ2xpZW50RXhjZXB0aW9uKCdjbGllbnQ6OnVwbG9hZC1mYWlsdXJlJywgYHVwbG9hZGVkIGNodW5rIG9mIGZpbGUgZmFpbGVkLCBleHBlY3RlZCByZXNwb25zZSB3aXRoIHByb3BlcnR5ICd1cGxvYWRlZEZpbGVTaXplJ2AsIHsgc2VydmljZTogc2VydmljZVN0ciwgYWN0aW9uOiBhY3Rpb25TdHIgfSkpXG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKCF1cGxvYWRDaHVua0RhdGEuZmluYWxDaHVuaykge1xuICAgICAgICAgICAgdXBsb2FkQ2h1bmtEYXRhLnJlc3VtZUF0ID0gTnVtYmVyKHBhcnNlZFJlc3BvbnNlLnVwbG9hZGVkRmlsZVNpemUpXG4gICAgICAgICAgICB1cGxvYWRDaHVua0RhdGEucmVzdW1lID0gdHJ1ZVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXNvbHZlKHBhcnNlZFJlc3BvbnNlKTtcbiAgICAgICAgfSlcbiAgICAgICAgLy8gaGFuZGxlIGVycm9yczpcbiAgICAgICAgLmNhdGNoKGUgPT4ge1xuICAgICAgICAgIGlzQ29tcGxldGUgPSB0cnVlXG4gICAgICAgICAgeE1lIHx8PSBlLnJlc3BvbnNlPy5oZWFkZXJzPy5bJ3gtbWUnXSB8fCAnJ1xuICAgICAgICAgIHhLYWx0dXJhU2Vzc2lvbiB8fD0gZS5yZXNwb25zZT8uaGVhZGVycz8uWyd4LWthbHR1cmEtc2Vzc2lvbiddIHx8ICcnXG4gICAgICAgICAgY29uc3QgbXNnID0gZS5yZXNwb25zZT8uYm9keSB8fCBlLm1lc3NhZ2UgfHwgJ2ZhaWxlZCB0byB1cGxvYWQgZmlsZSdcbiAgICAgICAgICBjb25zdCBlcnIgPSBuZXcgS2FsdHVyYUNsaWVudEV4Y2VwdGlvbignY2xpZW50Ojp1cGxvYWQtZmFpbHVyZScsIG1zZyk7XG4gICAgICAgICAgTG9nZ2VyLmVycm9yKGBLYWx0dXJhIHJlc3BvbnNlIGVycm9yOiAnJHttc2cgfHwgJyd9JywgZm9yOiAke3NlcnZpY2VTdHJ9LyR7YWN0aW9uU3RyfSwgeC1tZTogJHt4TWV9LCB4LWthbHR1cmEtc2Vzc2lvbjogJHt4S2FsdHVyYVNlc3Npb259YClcbiAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICB9KVxuICAgICAgfSlcblxuICAgICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgaWYgKCFpc0NvbXBsZXRlKSB7XG4gICAgICAgICAgaXNDb21wbGV0ZSA9IHRydWU7XG4gICAgICAgICAgaXNBYm9ydGVkID0gdHJ1ZVxuICAgICAgICAgIGdvdFJlcXVlc3Q/LmNhbmNlbCgpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSlcbiAgfVxufVxuIl19
