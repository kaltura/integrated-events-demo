"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createCancelableAction = exports.safeJsonParse = exports.prepareParameters = exports.getHeaders = exports.buildQuerystring = exports.createClientTag = exports.buildUrl = exports.createEndpoint = void 0;
var tslib_1 = require("tslib");
var cancelable_action_1 = require("../cancelable-action");
var kaltura_client_exception_1 = require("../api/kaltura-client-exception");
var environment_1 = require("../environment");
var got_1 = require("got");
var kaltura_logger_1 = require("../api/kaltura-logger");
function createEndpoint(request, options, service, action, additionalQueryParams) {
    var endpoint = options.endpointUrl;
    var clientTag = createClientTag(request, options);
    var url = "".concat(endpoint, "/api_v3/service/").concat(service);
    if (action) {
        url += "/action/".concat(action);
    }
    var queryParams = tslib_1.__assign(tslib_1.__assign({}, (additionalQueryParams || {})), (clientTag ? { clientTag: clientTag } : {}));
    return buildUrl(url, queryParams);
}
exports.createEndpoint = createEndpoint;
function buildUrl(url, querystring) {
    var formattedUrl = (url).trim();
    if (!querystring) {
        return formattedUrl;
    }
    var urlHasQuerystring = formattedUrl.indexOf('?') !== -1;
    var formattedQuerystring = _buildQuerystring(querystring);
    return "".concat(formattedUrl).concat(urlHasQuerystring ? '&' : '?').concat(formattedQuerystring);
}
exports.buildUrl = buildUrl;
function _buildQuerystring(data, prefix) {
    var str = [], p;
    for (p in data) {
        if (data.hasOwnProperty(p)) {
            var k = prefix ? prefix + "[" + p + "]" : p, v = data[p];
            str.push((v !== null && typeof v === "object") ?
                _buildQuerystring(v, k) :
                encodeURIComponent(k) + "=" + encodeURIComponent(v));
        }
    }
    return str.join("&");
}
function createClientTag(request, options) {
    var networkTag = (request.getNetworkTag() || "").trim();
    var clientTag = (options.clientTag || "").trim() || "ng-app";
    if (networkTag && networkTag.length) {
        return "".concat(clientTag, "_").concat(networkTag);
    }
    else {
        return clientTag;
    }
}
exports.createClientTag = createClientTag;
function buildQuerystring(data, prefix) {
    var str = [], p;
    for (p in data) {
        if (data.hasOwnProperty(p)) {
            var k = prefix ? prefix + "[" + p + "]" : p, v = data[p];
            str.push((v !== null && typeof v === "object") ?
                buildQuerystring(v, k) :
                encodeURIComponent(k) + "=" + encodeURIComponent(v));
        }
    }
    return str.join("&");
}
exports.buildQuerystring = buildQuerystring;
function getHeaders(customHeaders) {
    if (customHeaders === void 0) { customHeaders = {}; }
    var headers = tslib_1.__assign({ "Accept": "application/json", "Content-Type": "application/json" }, customHeaders);
    return headers;
}
exports.getHeaders = getHeaders;
function prepareParameters(request, options, defaultRequestOptions) {
    return Object.assign({}, request.buildRequest(defaultRequestOptions), {
        apiVersion: environment_1.environment.request.apiVersion,
        format: 1
    });
}
exports.prepareParameters = prepareParameters;
function safeJsonParse(obj) {
    try {
        return JSON.parse(obj);
    }
    catch (e) { /* noop */ }
}
exports.safeJsonParse = safeJsonParse;
function createCancelableAction(data, responseType) {
    var _a, _b;
    if (responseType === void 0) { responseType = 'json'; }
    var endPoint = (data === null || data === void 0 ? void 0 : data.endpoint) || '';
    var service = ((_a = endPoint === null || endPoint === void 0 ? void 0 : endPoint.match('service/([^\/]+)')) === null || _a === void 0 ? void 0 : _a[1]) || '';
    var action = ((_b = endPoint === null || endPoint === void 0 ? void 0 : endPoint.match('action/([^\?]+)')) === null || _b === void 0 ? void 0 : _b[1]) || '';
    var result = new cancelable_action_1.CancelableAction(function (resolve, reject) {
        var cancelableRequest = got_1.default.post(data.endpoint, {
            json: data.body,
            headers: data.headers,
        });
        var xMe, xKalturaSession;
        cancelableRequest.then(function (response) {
            var _a, _b;
            xMe = ((_a = response === null || response === void 0 ? void 0 : response.headers) === null || _a === void 0 ? void 0 : _a['x-me']) || '';
            xKalturaSession = ((_b = response === null || response === void 0 ? void 0 : response.headers) === null || _b === void 0 ? void 0 : _b['x-kaltura-session']) || '';
            kaltura_logger_1.Logger.debug("Kaltura response completed for: ".concat(service, "/").concat(action, ", x-me: ").concat(xMe, ", x-kaltura-session: ").concat(xKalturaSession, ", url: ").concat(endPoint));
        }).catch(function (e) {
            var _a, _b, _c, _d;
            xMe = ((_b = (_a = e === null || e === void 0 ? void 0 : e.response) === null || _a === void 0 ? void 0 : _a.headers) === null || _b === void 0 ? void 0 : _b['x-me']) || '';
            xKalturaSession = ((_d = (_c = e === null || e === void 0 ? void 0 : e.response) === null || _c === void 0 ? void 0 : _c.headers) === null || _d === void 0 ? void 0 : _d['x-kaltura-session']) || '';
        });
        cancelableRequest[responseType]()
            .then(function (response) {
            if (typeof response === 'string' && response.includes('KalturaAPIException')) {
                response = safeJsonParse(response) || response;
            }
            if ((response === null || response === void 0 ? void 0 : response.objectType) === 'KalturaAPIException') {
                kaltura_logger_1.Logger.error("Kaltura API Exception: '".concat(response.message || '', "', for: ").concat(service, "/").concat(action, ", x-me: ").concat(xMe, ", x-kaltura-session: ").concat(xKalturaSession, ", url: ").concat(endPoint));
            }
            return response;
        })
            .then(resolve)
            .catch(function (e) {
            var _a, _b, _c;
            kaltura_logger_1.Logger.error("Kaltura Error: '".concat(e.message, "', for: ").concat(service, "/").concat(action, ", x-me: ").concat(xMe, ", x-kaltura-session: ").concat(xKalturaSession, ", url: ").concat(endPoint));
            var args = xMe || xKalturaSession ? { xMe: xMe, xKalturaSession: xKalturaSession } : undefined;
            var error = ((_a = e.response) === null || _a === void 0 ? void 0 : _a.statusCode) === 200
                ? new Error((_b = e.response) === null || _b === void 0 ? void 0 : _b.body)
                : new kaltura_client_exception_1.KalturaClientException('client::failure', ((_c = e.response) === null || _c === void 0 ? void 0 : _c.body) || e.message || 'failed to transmit request', args);
            reject(error);
        });
        return function () { return cancelableRequest.cancel(); };
    });
    return result;
}
exports.createCancelableAction = createCancelableAction;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFDO0FBOUNELHdEQThDQyIsImZpbGUiOiJhZGFwdGVycy91dGlscy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEthbHR1cmFSZXF1ZXN0QmFzZSB9IGZyb20gJy4uL2FwaS9rYWx0dXJhLXJlcXVlc3QtYmFzZSc7XG5pbXBvcnQgeyBLYWx0dXJhQ2xpZW50T3B0aW9ucyB9IGZyb20gJy4uL2thbHR1cmEtY2xpZW50LW9wdGlvbnMnO1xuaW1wb3J0IHsgS2FsdHVyYVJlcXVlc3RPcHRpb25zIH0gZnJvbSAnLi4vYXBpL2thbHR1cmEtcmVxdWVzdC1vcHRpb25zJztcbmltcG9ydCB7IEthbHR1cmFNdWx0aVJlcXVlc3QgfSBmcm9tICcuLi9hcGkva2FsdHVyYS1tdWx0aS1yZXF1ZXN0JztcbmltcG9ydCB7IEthbHR1cmFSZXF1ZXN0IH0gZnJvbSAnLi4vYXBpL2thbHR1cmEtcmVxdWVzdCc7XG5pbXBvcnQgeyBLYWx0dXJhRmlsZVJlcXVlc3QgfSBmcm9tICcuLi9hcGkva2FsdHVyYS1maWxlLXJlcXVlc3QnO1xuaW1wb3J0IHsgQ2FuY2VsYWJsZUFjdGlvbiwgUmVzb2x2ZUZuIH0gZnJvbSAnLi4vY2FuY2VsYWJsZS1hY3Rpb24nO1xuaW1wb3J0IHsgS2FsdHVyYUNsaWVudEV4Y2VwdGlvbiB9IGZyb20gJy4uL2FwaS9rYWx0dXJhLWNsaWVudC1leGNlcHRpb24nO1xuaW1wb3J0IHsgZW52aXJvbm1lbnQgfSBmcm9tICcuLi9lbnZpcm9ubWVudCc7XG5pbXBvcnQgZ290IGZyb20gJ2dvdCc7XG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tIFwiLi4vYXBpL2thbHR1cmEtbG9nZ2VyXCI7XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVFbmRwb2ludChyZXF1ZXN0OiBLYWx0dXJhUmVxdWVzdEJhc2UsIG9wdGlvbnM6IEthbHR1cmFDbGllbnRPcHRpb25zLCBzZXJ2aWNlOiBzdHJpbmcsIGFjdGlvbj86IHN0cmluZywgYWRkaXRpb25hbFF1ZXJ5UGFyYW1zPzoge30pOiBzdHJpbmcge1xuICBjb25zdCBlbmRwb2ludCA9IG9wdGlvbnMuZW5kcG9pbnRVcmw7XG4gIGNvbnN0IGNsaWVudFRhZyA9IGNyZWF0ZUNsaWVudFRhZyhyZXF1ZXN0LCBvcHRpb25zKTtcbiAgbGV0IHVybCA9IGAke2VuZHBvaW50fS9hcGlfdjMvc2VydmljZS8ke3NlcnZpY2V9YDtcblxuICBpZiAoYWN0aW9uKSB7XG4gICAgdXJsICs9IGAvYWN0aW9uLyR7YWN0aW9ufWA7XG4gIH1cblxuICBjb25zdCBxdWVyeVBhcmFtcyA9IHtcbiAgICAuLi4oYWRkaXRpb25hbFF1ZXJ5UGFyYW1zIHx8IHt9KSxcbiAgICAuLi4oY2xpZW50VGFnID8geyBjbGllbnRUYWcgfSA6IHt9KVxuICB9O1xuXG4gIHJldHVybiBidWlsZFVybCh1cmwsIHF1ZXJ5UGFyYW1zKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGJ1aWxkVXJsKHVybDogc3RyaW5nLCBxdWVyeXN0cmluZz86IHt9KSB7XG4gIGxldCBmb3JtYXR0ZWRVcmwgPSAodXJsKS50cmltKCk7XG4gIGlmICghcXVlcnlzdHJpbmcpIHtcbiAgICByZXR1cm4gZm9ybWF0dGVkVXJsO1xuICB9XG4gIGNvbnN0IHVybEhhc1F1ZXJ5c3RyaW5nID0gZm9ybWF0dGVkVXJsLmluZGV4T2YoJz8nKSAhPT0gLTE7XG4gIGNvbnN0IGZvcm1hdHRlZFF1ZXJ5c3RyaW5nID0gX2J1aWxkUXVlcnlzdHJpbmcocXVlcnlzdHJpbmcpO1xuICByZXR1cm4gYCR7Zm9ybWF0dGVkVXJsfSR7dXJsSGFzUXVlcnlzdHJpbmcgPyAnJicgOiAnPyd9JHtmb3JtYXR0ZWRRdWVyeXN0cmluZ31gO1xufVxuXG5mdW5jdGlvbiBfYnVpbGRRdWVyeXN0cmluZyhkYXRhOiB7fSwgcHJlZml4Pzogc3RyaW5nKSB7XG4gIGxldCBzdHIgPSBbXSwgcDtcbiAgZm9yIChwIGluIGRhdGEpIHtcbiAgICBpZiAoZGF0YS5oYXNPd25Qcm9wZXJ0eShwKSkge1xuICAgICAgbGV0IGsgPSBwcmVmaXggPyBwcmVmaXggKyBcIltcIiArIHAgKyBcIl1cIiA6IHAsIHYgPSBkYXRhW3BdO1xuICAgICAgc3RyLnB1c2goKHYgIT09IG51bGwgJiYgdHlwZW9mIHYgPT09IFwib2JqZWN0XCIpID9cbiAgICAgICAgX2J1aWxkUXVlcnlzdHJpbmcodiwgaykgOlxuICAgICAgICBlbmNvZGVVUklDb21wb25lbnQoaykgKyBcIj1cIiArIGVuY29kZVVSSUNvbXBvbmVudCh2KSk7XG4gICAgfVxuICB9XG4gIHJldHVybiBzdHIuam9pbihcIiZcIik7XG5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUNsaWVudFRhZyhyZXF1ZXN0OiBLYWx0dXJhUmVxdWVzdEJhc2UsIG9wdGlvbnM6IEthbHR1cmFDbGllbnRPcHRpb25zKSB7XG4gIGNvbnN0IG5ldHdvcmtUYWcgPSAocmVxdWVzdC5nZXROZXR3b3JrVGFnKCkgfHwgXCJcIikudHJpbSgpO1xuICBjb25zdCBjbGllbnRUYWcgPSAob3B0aW9ucy5jbGllbnRUYWcgfHwgXCJcIikudHJpbSgpIHx8IFwibmctYXBwXCI7XG5cbiAgaWYgKG5ldHdvcmtUYWcgJiYgbmV0d29ya1RhZy5sZW5ndGgpIHtcbiAgICByZXR1cm4gYCR7Y2xpZW50VGFnfV8ke25ldHdvcmtUYWd9YDtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gY2xpZW50VGFnO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBidWlsZFF1ZXJ5c3RyaW5nKGRhdGE6IHt9LCBwcmVmaXg/OiBzdHJpbmcpIHtcbiAgbGV0IHN0ciA9IFtdLCBwO1xuICBmb3IgKHAgaW4gZGF0YSkge1xuICAgIGlmIChkYXRhLmhhc093blByb3BlcnR5KHApKSB7XG4gICAgICBsZXQgayA9IHByZWZpeCA/IHByZWZpeCArIFwiW1wiICsgcCArIFwiXVwiIDogcCwgdiA9IGRhdGFbcF07XG4gICAgICBzdHIucHVzaCgodiAhPT0gbnVsbCAmJiB0eXBlb2YgdiA9PT0gXCJvYmplY3RcIikgP1xuICAgICAgICBidWlsZFF1ZXJ5c3RyaW5nKHYsIGspIDpcbiAgICAgICAgZW5jb2RlVVJJQ29tcG9uZW50KGspICsgXCI9XCIgKyBlbmNvZGVVUklDb21wb25lbnQodikpO1xuICAgIH1cbiAgfVxuICByZXR1cm4gc3RyLmpvaW4oXCImXCIpO1xuXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRIZWFkZXJzKGN1c3RvbUhlYWRlcnMgPSB7fSk6IGFueSB7XG4gIGNvbnN0IGhlYWRlcnMgPSB7XG4gICAgXCJBY2NlcHRcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgLi4uY3VzdG9tSGVhZGVyc1xuICB9O1xuICByZXR1cm4gaGVhZGVyc1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJlcGFyZVBhcmFtZXRlcnMocmVxdWVzdDogS2FsdHVyYVJlcXVlc3Q8YW55PiB8IEthbHR1cmFNdWx0aVJlcXVlc3QgfCBLYWx0dXJhRmlsZVJlcXVlc3QsIG9wdGlvbnM6IEthbHR1cmFDbGllbnRPcHRpb25zLCBkZWZhdWx0UmVxdWVzdE9wdGlvbnM6IEthbHR1cmFSZXF1ZXN0T3B0aW9ucyk6IGFueSB7XG4gIHJldHVybiBPYmplY3QuYXNzaWduKFxuICAgIHt9LFxuICAgIHJlcXVlc3QuYnVpbGRSZXF1ZXN0KGRlZmF1bHRSZXF1ZXN0T3B0aW9ucyksXG4gICAge1xuICAgICAgYXBpVmVyc2lvbjogZW52aXJvbm1lbnQucmVxdWVzdC5hcGlWZXJzaW9uLFxuICAgICAgZm9ybWF0OiAxXG4gICAgfVxuICApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2FmZUpzb25QYXJzZShvYmo6IHN0cmluZyk6IG9iamVjdCB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIEpTT04ucGFyc2Uob2JqKVxuICB9IGNhdGNoIChlKSB7Lyogbm9vcCAqL31cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUNhbmNlbGFibGVBY3Rpb248VD4oXG4gIGRhdGE6IHsgZW5kcG9pbnQ6IHN0cmluZywgaGVhZGVyczogYW55LCBib2R5OiBhbnkgfSxcbiAgcmVzcG9uc2VUeXBlOiAnanNvbid8J3RleHQnID0gJ2pzb24nXG4pOiBDYW5jZWxhYmxlQWN0aW9uPFQ+IHtcbiAgY29uc3QgZW5kUG9pbnQgPSBkYXRhPy5lbmRwb2ludCB8fCAnJ1xuICBjb25zdCBzZXJ2aWNlID0gZW5kUG9pbnQ/Lm1hdGNoKCdzZXJ2aWNlLyhbXlxcL10rKScpPy5bMV0gfHwgJydcbiAgY29uc3QgYWN0aW9uID0gZW5kUG9pbnQ/Lm1hdGNoKCdhY3Rpb24vKFteXFw/XSspJyk/LlsxXSB8fCAnJ1xuXG4gIGNvbnN0IHJlc3VsdCA9IG5ldyBDYW5jZWxhYmxlQWN0aW9uPFQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBjb25zdCBjYW5jZWxhYmxlUmVxdWVzdCA9IGdvdC5wb3N0KGRhdGEuZW5kcG9pbnQsIHtcbiAgICAgIGpzb246IGRhdGEuYm9keSxcbiAgICAgIGhlYWRlcnM6IGRhdGEuaGVhZGVycyxcbiAgICB9KVxuXG4gICAgbGV0IHhNZSwgeEthbHR1cmFTZXNzaW9uXG4gICAgY2FuY2VsYWJsZVJlcXVlc3QudGhlbigocmVzcG9uc2UpID0+IHtcbiAgICAgIHhNZSA9IHJlc3BvbnNlPy5oZWFkZXJzPy5bJ3gtbWUnXSB8fCAnJ1xuICAgICAgeEthbHR1cmFTZXNzaW9uID0gcmVzcG9uc2U/LmhlYWRlcnM/LlsneC1rYWx0dXJhLXNlc3Npb24nXSB8fCAnJ1xuICAgICAgTG9nZ2VyLmRlYnVnKGBLYWx0dXJhIHJlc3BvbnNlIGNvbXBsZXRlZCBmb3I6ICR7c2VydmljZX0vJHthY3Rpb259LCB4LW1lOiAke3hNZX0sIHgta2FsdHVyYS1zZXNzaW9uOiAke3hLYWx0dXJhU2Vzc2lvbn0sIHVybDogJHtlbmRQb2ludH1gKVxuICAgIH0pLmNhdGNoKGUgPT4ge1xuICAgICAgeE1lID0gZT8ucmVzcG9uc2U/LmhlYWRlcnM/LlsneC1tZSddIHx8ICcnXG4gICAgICB4S2FsdHVyYVNlc3Npb24gPSBlPy5yZXNwb25zZT8uaGVhZGVycz8uWyd4LWthbHR1cmEtc2Vzc2lvbiddIHx8ICcnXG4gICAgfSlcblxuICAgIGNhbmNlbGFibGVSZXF1ZXN0W3Jlc3BvbnNlVHlwZV0oKVxuICAgICAgLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7XG4gICAgICAgIGlmICh0eXBlb2YgcmVzcG9uc2UgPT09ICdzdHJpbmcnICYmIHJlc3BvbnNlLmluY2x1ZGVzKCdLYWx0dXJhQVBJRXhjZXB0aW9uJykpIHtcbiAgICAgICAgICByZXNwb25zZSA9IHNhZmVKc29uUGFyc2UocmVzcG9uc2UpIHx8IHJlc3BvbnNlXG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3BvbnNlPy5vYmplY3RUeXBlID09PSAnS2FsdHVyYUFQSUV4Y2VwdGlvbicpIHtcbiAgICAgICAgICBMb2dnZXIuZXJyb3IoYEthbHR1cmEgQVBJIEV4Y2VwdGlvbjogJyR7cmVzcG9uc2UubWVzc2FnZSB8fCAnJ30nLCBmb3I6ICR7c2VydmljZX0vJHthY3Rpb259LCB4LW1lOiAke3hNZX0sIHgta2FsdHVyYS1zZXNzaW9uOiAke3hLYWx0dXJhU2Vzc2lvbn0sIHVybDogJHtlbmRQb2ludH1gKVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXNwb25zZVxuICAgICAgfSlcbiAgICAgIC50aGVuKDxSZXNvbHZlRm48YW55Pj5yZXNvbHZlKVxuICAgICAgLmNhdGNoKGUgPT4ge1xuICAgICAgICBMb2dnZXIuZXJyb3IoYEthbHR1cmEgRXJyb3I6ICcke2UubWVzc2FnZX0nLCBmb3I6ICR7c2VydmljZX0vJHthY3Rpb259LCB4LW1lOiAke3hNZX0sIHgta2FsdHVyYS1zZXNzaW9uOiAke3hLYWx0dXJhU2Vzc2lvbn0sIHVybDogJHtlbmRQb2ludH1gKVxuICAgICAgICBjb25zdCBhcmdzID0geE1lIHx8IHhLYWx0dXJhU2Vzc2lvbiA/IHsgeE1lLCB4S2FsdHVyYVNlc3Npb24gfSA6IHVuZGVmaW5lZCBcbiAgICAgICAgY29uc3QgZXJyb3IgPSBlLnJlc3BvbnNlPy5zdGF0dXNDb2RlID09PSAyMDBcbiAgICAgICAgICA/IG5ldyBFcnJvcihlLnJlc3BvbnNlPy5ib2R5KVxuICAgICAgICAgIDogbmV3IEthbHR1cmFDbGllbnRFeGNlcHRpb24oJ2NsaWVudDo6ZmFpbHVyZScsIGUucmVzcG9uc2U/LmJvZHkgfHwgZS5tZXNzYWdlIHx8ICdmYWlsZWQgdG8gdHJhbnNtaXQgcmVxdWVzdCcsIGFyZ3MpO1xuICAgICAgICByZWplY3QoZXJyb3IpXG4gICAgICB9KVxuICAgIHJldHVybiAoKSA9PiBjYW5jZWxhYmxlUmVxdWVzdC5jYW5jZWwoKVxuICB9KTtcbiAgcmV0dXJuIHJlc3VsdDtcbn1cbiJdfQ==
