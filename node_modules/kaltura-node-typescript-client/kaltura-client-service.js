"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.KalturaClient = void 0;
var tslib_1 = require("tslib");
var kaltura_request_1 = require("./api/kaltura-request");
var kaltura_multi_request_1 = require("./api/kaltura-multi-request");
var kaltura_file_request_1 = require("./api/kaltura-file-request");
var kaltura_upload_request_1 = require("./api/kaltura-upload-request");
var kaltura_request_adapter_1 = require("./adapters/kaltura-request-adapter");
var kaltura_file_request_adapter_1 = require("./adapters/kaltura-file-request-adapter");
var kaltura_multi_request_adapter_1 = require("./adapters/kaltura-multi-request-adapter");
var kaltura_client_exception_1 = require("./api/kaltura-client-exception");
var kaltura_upload_request_adapter_1 = require("./adapters/kaltura-upload-request-adapter");
var kaltura_request_options_1 = require("./api/kaltura-request-options");
var cancelable_action_1 = require("./cancelable-action");
var KalturaClient = /** @class */ (function () {
    function KalturaClient(_options, defaultRequestOptionsArgs) {
        this._options = _options;
        this._defaultRequestOptions = new kaltura_request_options_1.KalturaRequestOptions(defaultRequestOptionsArgs || {});
    }
    KalturaClient.prototype.appendOptions = function (options) {
        if (!options) {
            throw new kaltura_client_exception_1.KalturaClientException('client::append_options', "missing required argument 'options'");
        }
        this._options = Object.assign(this._options || {}, options);
    };
    KalturaClient.prototype.setOptions = function (options) {
        if (!options) {
            throw new kaltura_client_exception_1.KalturaClientException('client::set_options', "missing required argument 'options'");
        }
        this._options = options;
    };
    KalturaClient.prototype.appendDefaultRequestOptions = function (args) {
        if (!args) {
            throw new kaltura_client_exception_1.KalturaClientException('client::append_default_request_options', "missing required argument 'args'");
        }
        this._defaultRequestOptions = Object.assign(this._defaultRequestOptions || new kaltura_request_options_1.KalturaRequestOptions(), new kaltura_request_options_1.KalturaRequestOptions(args));
    };
    KalturaClient.prototype.setDefaultRequestOptions = function (args) {
        if (!args) {
            throw new kaltura_client_exception_1.KalturaClientException('client::set_default_request_options', "missing required argument 'args'");
        }
        this._defaultRequestOptions = new kaltura_request_options_1.KalturaRequestOptions(args);
    };
    KalturaClient.prototype.getDefaultRequestOptions = function () {
        return this._defaultRequestOptions;
    };
    KalturaClient.prototype._validateOptions = function () {
        if (!this._options) {
            return new kaltura_client_exception_1.KalturaClientException('client::missing_options', 'cannot transmit request, missing client options (did you forgot to provide options manually?)');
        }
        if (!this._options.endpointUrl) {
            return new kaltura_client_exception_1.KalturaClientException('client::missing_options', "cannot transmit request, missing 'endpointUrl' in client options");
        }
        if (!this._options.clientTag) {
            return new kaltura_client_exception_1.KalturaClientException('client::missing_options', "cannot transmit request, missing 'clientTag' in client options");
        }
        return null;
    };
    KalturaClient.prototype.request = function (request) {
        var optionsViolationError = this._validateOptions();
        if (optionsViolationError) {
            return cancelable_action_1.CancelableAction.reject(optionsViolationError);
        }
        if (request instanceof kaltura_file_request_1.KalturaFileRequest) {
            return new kaltura_file_request_adapter_1.KalturaFileRequestAdapter().transmit(request, this._options, this._defaultRequestOptions);
        }
        else if (request instanceof kaltura_upload_request_1.KalturaUploadRequest) {
            return new kaltura_upload_request_adapter_1.KalturaUploadRequestAdapter(this._options, this._defaultRequestOptions).transmit(request);
        }
        else if (request instanceof kaltura_request_1.KalturaRequest) {
            return new kaltura_request_adapter_1.KalturaRequestAdapter().transmit(request, this._options, this._defaultRequestOptions);
        }
        else {
            return cancelable_action_1.CancelableAction.reject(new kaltura_client_exception_1.KalturaClientException("client::request_type_error", 'unsupported request type requested'));
        }
    };
    KalturaClient.prototype.multiRequest = function (arg) {
        var optionsViolationError = this._validateOptions();
        if (optionsViolationError) {
            return cancelable_action_1.CancelableAction.reject(optionsViolationError);
        }
        var request = arg instanceof kaltura_multi_request_1.KalturaMultiRequest ? arg : (arg instanceof Array ? new (kaltura_multi_request_1.KalturaMultiRequest.bind.apply(kaltura_multi_request_1.KalturaMultiRequest, tslib_1.__spreadArray([void 0], arg, false)))() : null);
        if (!request) {
            return cancelable_action_1.CancelableAction.reject(new kaltura_client_exception_1.KalturaClientException('client::invalid_request', "Expected argument of type Array or KalturaMultiRequest"));
        }
        var containsFileRequest = request.requests.some(function (item) { return item instanceof kaltura_file_request_1.KalturaFileRequest; });
        if (containsFileRequest) {
            return cancelable_action_1.CancelableAction.reject(new kaltura_client_exception_1.KalturaClientException('client::invalid_request', "multi-request not support requests of type 'KalturaFileRequest', use regular request instead"));
        }
        else {
            return new kaltura_multi_request_adapter_1.KalturaMultiRequestAdapter().transmit(request, this._options, this._defaultRequestOptions);
        }
    };
    return KalturaClient;
}());
exports.KalturaClient = KalturaClient;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QixFQUFFLHdEQUF3RCxDQUFDLENBQUMsQ0FBQztTQUNqSjtRQUVELElBQU0sbUJBQW1CLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsVUFBQSxJQUFJLElBQUksT0FBQSxJQUFJLFlBQVkseUNBQWtCLEVBQWxDLENBQWtDLENBQUMsQ0FBQztRQUM5RixJQUFJLG1CQUFtQixFQUFFO1lBQ3ZCLE9BQU8sb0NBQWdCLENBQUMsTUFBTSxDQUFDLElBQUksaURBQXNCLENBQUMseUJBQXlCLEVBQUUsOEZBQThGLENBQUMsQ0FBQyxDQUFDO1NBQ3ZMO2FBQU07WUFDTCxPQUFPLElBQUksMERBQTBCLEVBQUUsQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLHNCQUFzQixDQUFDLENBQUM7U0FDdkc7SUFDSCxDQUFDO0lBQ0gsb0JBQUM7QUFBRCxDQTVHQSxBQTRHQyxJQUFBO0FBNUdZLHNDQUFhIiwiZmlsZSI6ImthbHR1cmEtY2xpZW50LXNlcnZpY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBLYWx0dXJhUmVxdWVzdCB9IGZyb20gJy4vYXBpL2thbHR1cmEtcmVxdWVzdCc7XG5pbXBvcnQgeyBLYWx0dXJhTXVsdGlSZXF1ZXN0IH0gZnJvbSAnLi9hcGkva2FsdHVyYS1tdWx0aS1yZXF1ZXN0JztcbmltcG9ydCB7IEthbHR1cmFNdWx0aVJlc3BvbnNlIH0gZnJvbSAnLi9hcGkva2FsdHVyYS1tdWx0aS1yZXNwb25zZSc7XG5pbXBvcnQgeyBLYWx0dXJhRmlsZVJlcXVlc3QgfSBmcm9tICcuL2FwaS9rYWx0dXJhLWZpbGUtcmVxdWVzdCc7XG5pbXBvcnQgeyBLYWx0dXJhVXBsb2FkUmVxdWVzdCB9IGZyb20gJy4vYXBpL2thbHR1cmEtdXBsb2FkLXJlcXVlc3QnO1xuaW1wb3J0IHsgS2FsdHVyYVJlcXVlc3RBZGFwdGVyIH0gZnJvbSAnLi9hZGFwdGVycy9rYWx0dXJhLXJlcXVlc3QtYWRhcHRlcic7XG5pbXBvcnQgeyBLYWx0dXJhRmlsZVJlcXVlc3RBZGFwdGVyIH0gZnJvbSAnLi9hZGFwdGVycy9rYWx0dXJhLWZpbGUtcmVxdWVzdC1hZGFwdGVyJztcbmltcG9ydCB7IEthbHR1cmFDbGllbnRPcHRpb25zIH0gZnJvbSAnLi9rYWx0dXJhLWNsaWVudC1vcHRpb25zJztcbmltcG9ydCB7IEthbHR1cmFNdWx0aVJlcXVlc3RBZGFwdGVyIH0gZnJvbSAnLi9hZGFwdGVycy9rYWx0dXJhLW11bHRpLXJlcXVlc3QtYWRhcHRlcic7XG5pbXBvcnQgeyBLYWx0dXJhQ2xpZW50RXhjZXB0aW9uIH0gZnJvbSAnLi9hcGkva2FsdHVyYS1jbGllbnQtZXhjZXB0aW9uJztcbmltcG9ydCB7IEthbHR1cmFVcGxvYWRSZXF1ZXN0QWRhcHRlciB9IGZyb20gJy4vYWRhcHRlcnMva2FsdHVyYS11cGxvYWQtcmVxdWVzdC1hZGFwdGVyJztcbmltcG9ydCB7XG4gIEthbHR1cmFSZXF1ZXN0T3B0aW9ucyxcbiAgS2FsdHVyYVJlcXVlc3RPcHRpb25zQXJnc1xufSBmcm9tICcuL2FwaS9rYWx0dXJhLXJlcXVlc3Qtb3B0aW9ucyc7XG5pbXBvcnQgeyBDYW5jZWxhYmxlQWN0aW9uIH0gZnJvbSAnLi9jYW5jZWxhYmxlLWFjdGlvbic7XG5cbmV4cG9ydCBjbGFzcyBLYWx0dXJhQ2xpZW50IHtcblxuICBwcml2YXRlIF9kZWZhdWx0UmVxdWVzdE9wdGlvbnM6IEthbHR1cmFSZXF1ZXN0T3B0aW9ucztcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9vcHRpb25zPzogS2FsdHVyYUNsaWVudE9wdGlvbnMsXG4gICAgZGVmYXVsdFJlcXVlc3RPcHRpb25zQXJncz86IEthbHR1cmFSZXF1ZXN0T3B0aW9uc0FyZ3MpIHtcbiAgICB0aGlzLl9kZWZhdWx0UmVxdWVzdE9wdGlvbnMgPSBuZXcgS2FsdHVyYVJlcXVlc3RPcHRpb25zKGRlZmF1bHRSZXF1ZXN0T3B0aW9uc0FyZ3MgfHwge30pO1xuICB9XG5cbiAgcHVibGljIGFwcGVuZE9wdGlvbnMob3B0aW9uczogS2FsdHVyYUNsaWVudE9wdGlvbnMpOiB2b2lkIHtcbiAgICBpZiAoIW9wdGlvbnMpIHtcbiAgICAgIHRocm93IG5ldyBLYWx0dXJhQ2xpZW50RXhjZXB0aW9uKCdjbGllbnQ6OmFwcGVuZF9vcHRpb25zJywgYG1pc3NpbmcgcmVxdWlyZWQgYXJndW1lbnQgJ29wdGlvbnMnYCk7XG4gICAgfVxuXG4gICAgdGhpcy5fb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oXG4gICAgICB0aGlzLl9vcHRpb25zIHx8IHt9LCBvcHRpb25zXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBzZXRPcHRpb25zKG9wdGlvbnM6IEthbHR1cmFDbGllbnRPcHRpb25zKTogdm9pZCB7XG4gICAgaWYgKCFvcHRpb25zKSB7XG4gICAgICB0aHJvdyBuZXcgS2FsdHVyYUNsaWVudEV4Y2VwdGlvbignY2xpZW50OjpzZXRfb3B0aW9ucycsIGBtaXNzaW5nIHJlcXVpcmVkIGFyZ3VtZW50ICdvcHRpb25zJ2ApO1xuICAgIH1cblxuICAgIHRoaXMuX29wdGlvbnMgPSBvcHRpb25zO1xuICB9XG5cbiAgcHVibGljIGFwcGVuZERlZmF1bHRSZXF1ZXN0T3B0aW9ucyhhcmdzOiBLYWx0dXJhUmVxdWVzdE9wdGlvbnNBcmdzKTogdm9pZCB7XG4gICAgaWYgKCFhcmdzKSB7XG4gICAgICB0aHJvdyBuZXcgS2FsdHVyYUNsaWVudEV4Y2VwdGlvbignY2xpZW50OjphcHBlbmRfZGVmYXVsdF9yZXF1ZXN0X29wdGlvbnMnLCBgbWlzc2luZyByZXF1aXJlZCBhcmd1bWVudCAnYXJncydgKTtcbiAgICB9XG5cbiAgICB0aGlzLl9kZWZhdWx0UmVxdWVzdE9wdGlvbnMgPSBPYmplY3QuYXNzaWduKFxuICAgICAgdGhpcy5fZGVmYXVsdFJlcXVlc3RPcHRpb25zIHx8IG5ldyBLYWx0dXJhUmVxdWVzdE9wdGlvbnMoKSwgbmV3IEthbHR1cmFSZXF1ZXN0T3B0aW9ucyhhcmdzKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgc2V0RGVmYXVsdFJlcXVlc3RPcHRpb25zKGFyZ3M6IEthbHR1cmFSZXF1ZXN0T3B0aW9uc0FyZ3MpOiB2b2lkIHtcbiAgICBpZiAoIWFyZ3MpIHtcbiAgICAgIHRocm93IG5ldyBLYWx0dXJhQ2xpZW50RXhjZXB0aW9uKCdjbGllbnQ6OnNldF9kZWZhdWx0X3JlcXVlc3Rfb3B0aW9ucycsIGBtaXNzaW5nIHJlcXVpcmVkIGFyZ3VtZW50ICdhcmdzJ2ApO1xuICAgIH1cblxuICAgIHRoaXMuX2RlZmF1bHRSZXF1ZXN0T3B0aW9ucyA9IG5ldyBLYWx0dXJhUmVxdWVzdE9wdGlvbnMoYXJncyk7XG4gIH1cblxuICBwdWJsaWMgZ2V0RGVmYXVsdFJlcXVlc3RPcHRpb25zKCk6IEthbHR1cmFSZXF1ZXN0T3B0aW9ucyB7XG4gICAgcmV0dXJuIHRoaXMuX2RlZmF1bHRSZXF1ZXN0T3B0aW9ucztcbiAgfVxuXG4gIHByaXZhdGUgX3ZhbGlkYXRlT3B0aW9ucygpOiBFcnJvciB8IG51bGwge1xuICAgIGlmICghdGhpcy5fb3B0aW9ucykge1xuICAgICAgcmV0dXJuIG5ldyBLYWx0dXJhQ2xpZW50RXhjZXB0aW9uKCdjbGllbnQ6Om1pc3Npbmdfb3B0aW9ucycsICdjYW5ub3QgdHJhbnNtaXQgcmVxdWVzdCwgbWlzc2luZyBjbGllbnQgb3B0aW9ucyAoZGlkIHlvdSBmb3Jnb3QgdG8gcHJvdmlkZSBvcHRpb25zIG1hbnVhbGx5PyknKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuX29wdGlvbnMuZW5kcG9pbnRVcmwpIHtcbiAgICAgIHJldHVybiBuZXcgS2FsdHVyYUNsaWVudEV4Y2VwdGlvbignY2xpZW50OjptaXNzaW5nX29wdGlvbnMnLCBgY2Fubm90IHRyYW5zbWl0IHJlcXVlc3QsIG1pc3NpbmcgJ2VuZHBvaW50VXJsJyBpbiBjbGllbnQgb3B0aW9uc2ApO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5fb3B0aW9ucy5jbGllbnRUYWcpIHtcbiAgICAgIHJldHVybiBuZXcgS2FsdHVyYUNsaWVudEV4Y2VwdGlvbignY2xpZW50OjptaXNzaW5nX29wdGlvbnMnLCBgY2Fubm90IHRyYW5zbWl0IHJlcXVlc3QsIG1pc3NpbmcgJ2NsaWVudFRhZycgaW4gY2xpZW50IG9wdGlvbnNgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHB1YmxpYyByZXF1ZXN0PFQ+KHJlcXVlc3Q6IEthbHR1cmFSZXF1ZXN0PFQ+KTogQ2FuY2VsYWJsZUFjdGlvbjxUPjtcbiAgcHVibGljIHJlcXVlc3Q8VD4ocmVxdWVzdDogS2FsdHVyYUZpbGVSZXF1ZXN0KTogQ2FuY2VsYWJsZUFjdGlvbjxzdHJpbmc+O1xuICBwdWJsaWMgcmVxdWVzdDxUPihyZXF1ZXN0OiBLYWx0dXJhUmVxdWVzdDxUPiB8IEthbHR1cmFGaWxlUmVxdWVzdCk6IENhbmNlbGFibGVBY3Rpb248VHxzdHJpbmc+IHtcblxuICAgIGNvbnN0IG9wdGlvbnNWaW9sYXRpb25FcnJvciA9IHRoaXMuX3ZhbGlkYXRlT3B0aW9ucygpO1xuXG4gICAgaWYgKG9wdGlvbnNWaW9sYXRpb25FcnJvcikge1xuICAgICAgcmV0dXJuIENhbmNlbGFibGVBY3Rpb24ucmVqZWN0KG9wdGlvbnNWaW9sYXRpb25FcnJvcik7XG4gICAgfVxuXG4gICAgaWYgKHJlcXVlc3QgaW5zdGFuY2VvZiBLYWx0dXJhRmlsZVJlcXVlc3QpIHtcbiAgICAgIHJldHVybiBuZXcgS2FsdHVyYUZpbGVSZXF1ZXN0QWRhcHRlcigpLnRyYW5zbWl0KHJlcXVlc3QsIHRoaXMuX29wdGlvbnMsIHRoaXMuX2RlZmF1bHRSZXF1ZXN0T3B0aW9ucyk7XG5cbiAgICB9IGVsc2UgaWYgKHJlcXVlc3QgaW5zdGFuY2VvZiBLYWx0dXJhVXBsb2FkUmVxdWVzdCkge1xuICAgICAgcmV0dXJuIG5ldyBLYWx0dXJhVXBsb2FkUmVxdWVzdEFkYXB0ZXIodGhpcy5fb3B0aW9ucywgdGhpcy5fZGVmYXVsdFJlcXVlc3RPcHRpb25zKS50cmFuc21pdChyZXF1ZXN0KTtcbiAgICB9XG4gICAgZWxzZSBpZiAocmVxdWVzdCBpbnN0YW5jZW9mIEthbHR1cmFSZXF1ZXN0KSB7XG4gICAgICByZXR1cm4gbmV3IEthbHR1cmFSZXF1ZXN0QWRhcHRlcigpLnRyYW5zbWl0KHJlcXVlc3QsIHRoaXMuX29wdGlvbnMsIHRoaXMuX2RlZmF1bHRSZXF1ZXN0T3B0aW9ucyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBDYW5jZWxhYmxlQWN0aW9uLnJlamVjdChuZXcgS2FsdHVyYUNsaWVudEV4Y2VwdGlvbihcImNsaWVudDo6cmVxdWVzdF90eXBlX2Vycm9yXCIsICd1bnN1cHBvcnRlZCByZXF1ZXN0IHR5cGUgcmVxdWVzdGVkJykpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBtdWx0aVJlcXVlc3QocmVxdWVzdHM6IEthbHR1cmFSZXF1ZXN0PGFueT5bXSk6IENhbmNlbGFibGVBY3Rpb248S2FsdHVyYU11bHRpUmVzcG9uc2U+XG4gIHB1YmxpYyBtdWx0aVJlcXVlc3QocmVxdWVzdDogS2FsdHVyYU11bHRpUmVxdWVzdCk6IENhbmNlbGFibGVBY3Rpb248S2FsdHVyYU11bHRpUmVzcG9uc2U+O1xuICBwdWJsaWMgbXVsdGlSZXF1ZXN0KGFyZzogS2FsdHVyYU11bHRpUmVxdWVzdCB8IEthbHR1cmFSZXF1ZXN0PGFueT5bXSk6IENhbmNlbGFibGVBY3Rpb248S2FsdHVyYU11bHRpUmVzcG9uc2U+IHtcbiAgICBjb25zdCBvcHRpb25zVmlvbGF0aW9uRXJyb3IgPSB0aGlzLl92YWxpZGF0ZU9wdGlvbnMoKTtcbiAgICBpZiAob3B0aW9uc1Zpb2xhdGlvbkVycm9yKSB7XG4gICAgICByZXR1cm4gQ2FuY2VsYWJsZUFjdGlvbi5yZWplY3Qob3B0aW9uc1Zpb2xhdGlvbkVycm9yKTtcbiAgICB9XG5cbiAgICBjb25zdCByZXF1ZXN0ID0gYXJnIGluc3RhbmNlb2YgS2FsdHVyYU11bHRpUmVxdWVzdCA/IGFyZyA6IChhcmcgaW5zdGFuY2VvZiBBcnJheSA/IG5ldyBLYWx0dXJhTXVsdGlSZXF1ZXN0KC4uLmFyZykgOiBudWxsKTtcbiAgICBpZiAoIXJlcXVlc3QpIHtcbiAgICAgIHJldHVybiBDYW5jZWxhYmxlQWN0aW9uLnJlamVjdChuZXcgS2FsdHVyYUNsaWVudEV4Y2VwdGlvbignY2xpZW50OjppbnZhbGlkX3JlcXVlc3QnLCBgRXhwZWN0ZWQgYXJndW1lbnQgb2YgdHlwZSBBcnJheSBvciBLYWx0dXJhTXVsdGlSZXF1ZXN0YCkpO1xuICAgIH1cblxuICAgIGNvbnN0IGNvbnRhaW5zRmlsZVJlcXVlc3QgPSByZXF1ZXN0LnJlcXVlc3RzLnNvbWUoaXRlbSA9PiBpdGVtIGluc3RhbmNlb2YgS2FsdHVyYUZpbGVSZXF1ZXN0KTtcbiAgICBpZiAoY29udGFpbnNGaWxlUmVxdWVzdCkge1xuICAgICAgcmV0dXJuIENhbmNlbGFibGVBY3Rpb24ucmVqZWN0KG5ldyBLYWx0dXJhQ2xpZW50RXhjZXB0aW9uKCdjbGllbnQ6OmludmFsaWRfcmVxdWVzdCcsIGBtdWx0aS1yZXF1ZXN0IG5vdCBzdXBwb3J0IHJlcXVlc3RzIG9mIHR5cGUgJ0thbHR1cmFGaWxlUmVxdWVzdCcsIHVzZSByZWd1bGFyIHJlcXVlc3QgaW5zdGVhZGApKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG5ldyBLYWx0dXJhTXVsdGlSZXF1ZXN0QWRhcHRlcigpLnRyYW5zbWl0KHJlcXVlc3QsIHRoaXMuX29wdGlvbnMsIHRoaXMuX2RlZmF1bHRSZXF1ZXN0T3B0aW9ucyk7XG4gICAgfVxuICB9XG59XG4iXX0=
